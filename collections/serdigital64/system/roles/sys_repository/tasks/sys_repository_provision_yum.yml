---
- name: "System / Repository / Provision / YUM / Check required parameters"
  ansible.builtin.assert:
    quiet: true
    that:
      - sys_repository___provision_repo['name'] is defined
      - sys_repository___provision_repo['name'] | length > 0
      - sys_repository___provision_repo['url'] is defined
      - sys_repository___provision_repo['url'] | length > 0
      - sys_repository___provision_repo['description'] is defined
      - sys_repository___provision_repo['description'] | length > 0

- name: "System / Repository / Provision / YUM / Detect if repo is already installed (repo: {{ sys_repository___provision_repo['name'] }})"
  ansible.builtin.stat:
    follow: false
    get_checksum: false
    get_mime: false
    get_attributes: false
    path: "{{
      sys_repository_base['etc']['yum_repos_d'] + '/' +
      sys_repository___provision_repo['name'] + '.repo'
      }}"
  register: "sys_repository___provision_test"

- name: "System / Repository / Provision / YUM / Create definition file (repo: {{ sys_repository___provision_repo['name'] }})"
  become: true
  ansible.builtin.template:
    backup: false
    follow: false
    force: true
    unsafe_writes: false
    owner: "{{ sys_repository_base['access']['owner'] }}"
    group: "{{ sys_repository_base['access']['group'] }}"
    mode: "{{ sys_repository_base['access']['mode']['file'] }}"
    src: "{{ sys_repository_base['templates']['yum_repo'] }}"
    dest: "{{
      sys_repository_base['etc']['yum_repos_d'] + '/' +
      sys_repository___provision_repo['name'] + '.repo'
      }}"
  when:
    - not sys_repository___provision_test['stat']['exists']

- name: "System / Repository / Provision / YUM / Register GPG Key (repo: {{ sys_repository___provision_repo['name'] }})"
  become: true
  ansible.builtin.command:
    argv:
      - "{{ sys_repository_base['run']['rpm'] }}"
      - "--import"
      - "{{ sys_repository___provision_repo['gpgkey'] }}"
  register: "sys_repository___provision_result"
  changed_when:
    - sys_repository___provision_result['rc'] == 0
  when:
    - not sys_repository___provision_test['stat']['exists']
...
